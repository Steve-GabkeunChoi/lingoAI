<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éŸ“å›½èªå­¦ç¿’</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex; flex-direction: column;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      z-index: -1;
    }
    header {
      display: flex; align-items: center;
      padding: 10px 20px;
      background-color: rgba(255,255,255,0.95);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: fixed; top: 0; width: 100%; z-index: 10;
    }
    header img { height: 40px; margin-right: 10px; }
    header h1 { font-size: 20px; margin: 0; }
    header .info-btn {
      margin-left: auto; margin-right: 40px;
      background-color: #007bff; color: #fff;
      border: none; padding: 8px 12px;
      border-radius: 10px; cursor: pointer; font-size: 16px;
    }
    header .info-btn:hover { background-color: #0056b3; }
    .main {
      flex: 1; display: flex;
      justify-content: center; align-items: center;
      padding: 80px 0 40px;
    }
    .container {
      width: 90%; max-width: 700px;
      background: rgba(255,255,255,0.9);
      padding: 30px; border-radius: 16px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .korean-sentence, .translation {
      font-size: 28px; font-weight: bold; margin-bottom: 10px;
    }
    .translation { font-size: 22px; color: #333; margin-bottom: 20px; }
    .btn {
      background-color: #007bff; color: #fff;
      border: none; padding: 12px 20px; margin: 8px;
      border-radius: 10px; cursor: pointer; font-size: 16px;
    }
    .btn:hover { background-color: #0056b3; }
    .result-box {
      display: none; background: #f1f3f5;
      border-radius: 10px; padding: 20px;
      margin-top: 20px; text-align: left;
    }
    #score-bar {
      width: 100%; height: 20px;
      background-color: #dee2e6; margin: 10px 0;
      border-radius: 10px;
    }
    #score-fill {
      height: 100%; width: 0%;
      background-color: #28a745; border-radius: 10px;
    }
    .highlight-wrong { color: red; font-weight: bold; }
    audio { margin-top: 10px; width: 100%; }
    table { display: none; width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc; padding: 6px; text-align: center;
    }
    th { background-color: #f1f1f1; }
    .popup {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center; z-index: 20;
    }
    .popup-content {
      background: #fff; padding: 20px;
      border-radius: 10px; max-width: 500px; position: relative;
      text-align: left;
    }
    .popup-close {
      position: absolute; top: 10px; right: 10px;
      border: none; background: none; font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo">
    <h1>éŸ“å›½èªå­¦ç¿’</h1>
    <button class="info-btn" onclick="showInfo()">â„¹ï¸ æ©Ÿèƒ½èª¬æ˜</button>
  </header>

  <div class="main">
    <div class="container">
      <h2>éŸ“å›½èª å­¦ç¿’</h2>
      <p>ä»¥ä¸‹ã®æ–‡ã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã€ç™ºéŸ³ã‚’ç·´ç¿’ã—ã¾ã—ã‚‡ã†ï¼š</p>
      <div class="korean-sentence" id="sentence">ì§€ê¸ˆ ìš©ì ‘ ì‘ì—… ì‹œì‘í•˜ì„¸ìš”.</div>
      <div class="translation" id="translation">ä»Šã™ãæº¶æ¥ä½œæ¥­ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚</div>

      <button class="btn" onclick="speakKorean()">ğŸ”Š ç™ºéŸ³ã‚’èã</button>
      <button class="btn" onclick="recordAudio()">ğŸ¤ ç™ºéŸ³éŒ²éŸ³ï¼†è©•ä¾¡</button>
      <button class="btn" onclick="nextSentence()">â¡ï¸ æ¬¡ã®æ–‡</button>

      <div class="result-box" id="result-box">
        <strong>ç™ºéŸ³åˆ†æ:</strong>
        <div id="comparison"></div>
        <div id="score-bar"><div id="score-fill"></div></div>
        <p>ç™ºéŸ³ã‚¹ã‚³ã‚¢: <span id="score">0%</span></p>
        <audio id="audio-player" controls></audio>
        <a id="download-link" class="btn" style="display:none;" download="recording.webm">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
      </div>

      <table id="record-table">
        <thead>
          <tr><th>#</th><th>åŸæ–‡</th><th>èªè­˜çµæœ</th><th>ã‚¹ã‚³ã‚¢(%)</th></tr>
        </thead>
        <tbody id="record-body"></tbody>
      </table>
    </div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-content">
      <button class="popup-close" onclick="closeInfo()">âœ–</button>
      <div id="popup-text"></div>
    </div>
  </div>
<script>
  const sentences = [
    { kr: "ë„ˆ ë­”ë° ìê¾¸ ìƒê°ë‚˜?", ja: "ã‚ãªãŸã£ã¦ä½•ï¼Ÿãšã£ã¨æ€ã„å‡ºã—ã¡ã‚ƒã†ã®ã€‚" },
    { kr: "ìì¡´ì‹¬ ìƒí•´ ì• ê°€ íƒ€", ja: "ãƒ—ãƒ©ã‚¤ãƒ‰ãŒå‚·ã¤ã„ã¦ã€ã‚‚ã©ã‹ã—ã„ã®ã€‚" },
    { kr: "ì–¼êµ´ì´ ëœ¨ê²ê³  ê°€ìŠ´ì€ ê³„ì† ë›°ì–´", ja: "é¡”ãŒç†±ãã¦ã€å¿ƒè‡“ãŒãƒ‰ã‚­ãƒ‰ã‚­ã—ã¦ã‚‹ã€‚" },
    { kr: "ë‚´ ëª¸ì´ ë§˜ëŒ€ë¡œ ì•ˆ ë¼, ì–´ì§€ëŸ¬ì›Œ", ja: "ä½“ãŒæ€ã†ã‚ˆã†ã«å‹•ã‹ãªãã¦ã€ã‚ã¾ã„ãŒã™ã‚‹ã€‚" },
    { kr: "ë„Œ í•œ ì¤Œì˜ ëª¨ë˜ ê°™ì•„", ja: "ã‚ãªãŸã¯ä¸€æ¡ã‚Šã®ç ‚ã¿ãŸã„ã€‚" },
    { kr: "ì¡í ë“¯ ì¡íˆì§€ ì•Šì•„", ja: "æ´ã‚ãã†ã§æ´ã‚ãªã„ã€‚" },
    { kr: "ë„Œ ì‰½ì§€ ì•Šì€ ê±¸, ê·¸ë˜ì„œ ë” ëŒë ¤", ja: "ç°¡å˜ã˜ã‚ƒãªã„ã‹ã‚‰ã€ã‚‚ã£ã¨æƒ¹ã‹ã‚Œã‚‹ã®ã€‚" },
    { kr: "ë‚´ ë§˜ì´ ë§˜ëŒ€ë¡œ ì•ˆ ë¼, ì–´ì´ì—†ì–´", ja: "æ°—æŒã¡ãŒæ€ã„é€šã‚Šã«ãªã‚‰ãªãã¦ã€å‘†ã‚Œã‚‹ã‚ã€‚" },
    { kr: "ì§€ê¸ˆ ë„ˆë¥¼ ì›í•˜ëŠ” ë‚´ ìˆ¨ê²°ì´ ëŠê»´ì§€ë‹ˆ?", ja: "ä»Šã€ã‚ãªãŸã‚’æ±‚ã‚ã‚‹ç§ã®æ¯ã¥ã‹ã„ãŒèã“ãˆã‚‹ï¼Ÿ" },
    { kr: "ë„ ë°”ë¼ë³´ê³  ìˆì–´ë„ missing you", ja: "è¦‹ã¤ã‚ã¦ã„ã¦ã‚‚ä¼šã„ãŸã„æ°—æŒã¡ã¯æ¶ˆãˆãªã„ã®ã€‚" },
    { kr: "ì„œíˆ° ë‚ , won't you set me free?", ja: "ä¸å™¨ç”¨ãªç§ã‚’ã€è§£ãæ”¾ã£ã¦ãã‚Œãªã„ï¼Ÿ" },
    { kr: "Baby, ë‚  í„°ì§ˆ ê²ƒì²˜ëŸ¼ ì•ˆì•„ì¤˜", ja: "ãƒ™ã‚¤ãƒ“ãƒ¼ã€å¼¾ã‘ãã†ãªãã‚‰ã„æŠ±ãã—ã‚ã¦ã€‚" },
    { kr: "ê·¸ë§Œ ìƒê°í•´, ë­ê°€ ê·¸ë¦¬ ì–´ë ¤ì›Œ?", ja: "ã‚‚ã†è€ƒãˆã™ããªã„ã§ã€ãã‚“ãªã«é›£ã—ã„ã“ã¨ï¼Ÿ" },
    { kr: "ê±°ì§“ë§ì²˜ëŸ¼ í‚¤ìŠ¤í•´ì¤˜", ja: "å˜˜ã¿ãŸã„ã«ã‚­ã‚¹ã—ã¦ã‚ˆã€‚" },
    { kr: "ë‚´ê°€ ë„ˆì—ê²Œ ë§ˆì§€ë§‰ ì‚¬ë‘ì¸ ê²ƒì²˜ëŸ¼", ja: "ç§ãŒã‚ãªãŸã®æœ€å¾Œã®æ‹äººã§ã‚ã‚‹ã‹ã®ã‚ˆã†ã«ã€‚" },
    { kr: "ë§ˆì§€ë§‰ ë°¤ì¸ ê²ƒì²˜ëŸ¼, love", ja: "æœ€å¾Œã®å¤œã®ã‚ˆã†ã«ã€æ„›ã—ã¦ã€‚" },
    { kr: "ë‚´ì¼ ë”°ìœˆ ì—†ëŠ” ê²ƒì²˜ëŸ¼, love", ja: "æ˜æ—¥ãªã‚“ã¦ãªã„ã‹ã®ã‚ˆã†ã«ã€æ„›ã—ã¦ã€‚" },
    { kr: "ì‹œê°„ì€ í˜ëŸ¬ê°€ëŠ”ë°, ë§ˆìŒë§Œ ê¸‰í•´ì§€ì§€", ja: "æ™‚é–“ã¯æµã‚Œã¦ã„ãã‘ã©ã€æ°—æŒã¡ã ã‘ãŒç„¦ã£ã¦ã‚‹ã€‚" },
    { kr: "ë‚´ ì„¸ìƒì€ ë„ˆ í•˜ë‚˜ë§Œ missing you", ja: "ç§ã®ä¸–ç•Œã«ã¯ã‚ãªãŸã ã‘ã€ä¼šã„ãŸãã¦ãŸã¾ã‚‰ãªã„ã®ã€‚" },
    { kr: "One, two, three, ìƒˆë¡œìš´ ì‹œì‘ì´ì•¼", ja: "ãƒ¯ãƒ³ã€ãƒ„ãƒ¼ã€ã‚¹ãƒªãƒ¼ã€æ–°ãŸãªå§‹ã¾ã‚Šã‚ˆã€‚" },
    { kr: "ì ˆëŒ€ ë’¤ëŒì•„ë³´ì§„ ì•Šì„ ê±°ë‹ˆê¹Œ", ja: "çµ¶å¯¾ã«æŒ¯ã‚Šè¿”ã‚‰ãªã„ã‹ã‚‰ã€‚" },
    { kr: "ë‚  ë„ˆì—ê²Œ ë˜ì§€ë©´, ë„ˆëŠ” ë‚  ê¼­ ì¡ì•„ì¤˜", ja: "ç§ã‚’ã‚ãªãŸã«æŠ•ã’ãŸã‚‰ã€ã—ã£ã‹ã‚Šå—ã‘æ­¢ã‚ã¦ã­ã€‚" },
    { kr: "ì„¸ìƒì€ ìš°ë¦´ êº¾ì§€ ëª»í•  í…Œë‹ˆê¹Œ", ja: "ä¸–ç•Œã¯ç§ãŸã¡ã‚’å£Šã›ãªã„ã‹ã‚‰ã€‚" }
  ];

  let idx = 0, mediaRecorder, audioChunks = [], recordCount = 0;
  let isRecording = false;
  let recog;

  function speakKorean() {
    const u = new SpeechSynthesisUtterance(sentences[idx].kr);
    u.lang = 'ko-KR';
    speechSynthesis.speak(u);
  }

  function nextSentence() {
    idx = (idx + 1) % sentences.length;
    document.getElementById("sentence").innerText = sentences[idx].kr;
    document.getElementById("translation").innerText = sentences[idx].ja;
    document.getElementById("result-box").style.display = 'none';
  }

  async function recordAudio() {
    const btn = event.currentTarget;

    if (!isRecording) {
      btn.innerText = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
      btn.style.backgroundColor = 'red';
      isRecording = true;

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recog.lang = 'ko-KR';
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      recog.start();
      mediaRecorder.start();

      recog.onresult = e => {
        const spoken = e.results[0][0].transcript;
        const score = levenshteinScore(sentences[idx].kr, spoken);
        document.getElementById("comparison").innerHTML = highlightDiff(sentences[idx].kr, spoken);
        document.getElementById("score").innerText = score + '%';
        document.getElementById("score-fill").style.width = score + '%';
        document.getElementById("result-box").style.display = 'block';

        recordCount++;
        document.getElementById("record-body")
          .insertAdjacentHTML('beforeend',
            `<tr><td>${recordCount}</td><td>${sentences[idx].kr}</td><td>${spoken}</td><td>${score}</td></tr>`);
        document.getElementById("record-table").style.display = 'table';
      };

      recog.onerror = () => stopRecording(btn);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        document.getElementById("audio-player").src = url;
        const dl = document.getElementById("download-link");
        dl.href = url;
        dl.style.display = 'inline-block';
      };

    } else {
      stopRecording(btn);
    }
  }

  function stopRecording(btn) {
    if (isRecording) {
      isRecording = false;
      btn.innerText = "ğŸ¤ ë°œìŒë…¹ìŒï¼†è©•ä¾¡";
      btn.style.backgroundColor = '#007bff';
      if (mediaRecorder?.state === "recording") mediaRecorder.stop();
      if (recog) recog.stop();
    }
  }

  function levenshteinScore(a, b) {
    const m = []; const n = a.length; const p = b.length;
    for (let i = 0; i <= p; i++) m[i] = [i];
    for (let j = 0; j <= n; j++) m[0][j] = j;
    for (let i = 1; i <= p; i++) {
      for (let j = 1; j <= n; j++) {
        m[i][j] = b[i - 1] === a[j - 1]
          ? m[i - 1][j - 1]
          : Math.min(m[i - 1][j] + 1, m[i][j - 1] + 1, m[i - 1][j - 1] + 1);
      }
    }
    const dist = m[p][n];
    return Math.max(0, Math.round((1 - dist / n) * 100));
  }

  function highlightDiff(exp, spk) {
    let out = ''; const L = Math.min(exp.length, spk.length);
    for (let i = 0; i < L; i++) {
      out += exp[i] === spk[i] ? exp[i] : `<span class="highlight-wrong">${spk[i]}</span>`;
    }
    if (spk.length > exp.length) {
      out += `<span class="highlight-wrong">${spk.slice(exp.length)}</span>`;
    }
    return `<p><strong>èªè­˜çµæœ:</strong> ${out}</p>`;
  }

  function showInfo() {
    const txt =
      'ğŸ”Š <strong>ç™ºéŸ³ã‚’èã</strong>ï¼šã‚·ã‚¹ãƒ†ãƒ ã®éŸ³å£°ã§éŸ“å›½èªã®æ–‡ã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚<br>' +
      'ğŸ¤ <strong>ç™ºéŸ³éŒ²éŸ³ï¼†è©•ä¾¡</strong>ï¼šã‚ãªãŸã®ç™ºéŸ³ã‚’éŒ²éŸ³ã—ã€æ­£ã—ã„æ–‡ã¨æ¯”è¼ƒã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã¾ã™ã€‚<br>' +
      'â¡ï¸ <strong>æ¬¡ã®æ–‡</strong>ï¼šæ¬¡ã®éŸ“å›½èªã®æ–‡ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚<br>' +
      'â„¹ï¸ <strong>æ©Ÿèƒ½èª¬æ˜</strong>ï¼šã“ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚';

    document.getElementById("popup-text").innerHTML = txt;
    document.getElementById("popup").style.display = 'flex';

    const utterance = new SpeechSynthesisUtterance(
      'ç™ºéŸ³ã‚’èãï¼šã‚·ã‚¹ãƒ†ãƒ ã®éŸ³å£°ã§éŸ“å›½èªã®æ–‡ã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚' +
      'ç™ºéŸ³éŒ²éŸ³ï¼†è©•ä¾¡ï¼šã‚ãªãŸã®ç™ºéŸ³ã‚’éŒ²éŸ³ã—ã€æ­£ã—ã„æ–‡ã¨æ¯”è¼ƒã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã¾ã™ã€‚' +
      'æ¬¡ã®æ–‡ï¼šæ¬¡ã®éŸ“å›½èªã®æ–‡ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚' +
      'æ©Ÿèƒ½èª¬æ˜ï¼šã“ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚'
    );
    utterance.lang = 'ja-JP';
    speechSynthesis.speak(utterance);
  }

  function closeInfo() {
    document.getElementById("popup").style.display = 'none';
  }

  window.onload = () => { nextSentence(); };
</script>
</body>
</html>
